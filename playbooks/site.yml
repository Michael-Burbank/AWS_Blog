- name: Configure TLS with Certbot for Nginx
  hosts: web
  become: true
  vars:
    domain_name: michael-burbank.com
    certbot_email: mike.w.burbank@gmail.com
    web_root: /var/www/myapp
    aws_region: us-west-1

  tasks:
    # Nginx (required for certbot --nginx).
    - name: Install Nginx on Amazon Linux 2
      ansible.builtin.command: amazon-linux-extras install nginx1 -y
      args:
        creates: /etc/nginx/nginx.conf
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Install Nginx on Amazon Linux 2023
      ansible.builtin.dnf:
        name: nginx
        state: present
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2023', '==')

    - name: Ensure /etc/nginx/conf.d exists
      ansible.builtin.file:
        path: /etc/nginx/conf.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Ensure web root exists
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Configure Nginx server block for domain (HTTP)
      ansible.builtin.copy:
        dest: /etc/nginx/conf.d/myapp.conf
        content: |
          server {
              listen 80;
              server_name {{ domain_name }} www.{{ domain_name }};
              root {{ web_root }};
              index index.html;

              # Optional: ensure ACME HTTP-01 challenge is servable
              location ^~ /.well-known/acme-challenge/ {
                  default_type "text/plain";
              }

              location / {
                  try_files $uri $uri/ =404;
              }
          }
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Validate Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: Enable and start Nginx
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      when: nginx_test.rc == 0

    # Certbot install.
    - name: Enable EPEL on Amazon Linux 2 (for snapd)
      ansible.builtin.command: amazon-linux-extras install epel -y
      args:
        creates: /etc/yum.repos.d/epel.repo
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Install snapd on Amazon Linux 2
      ansible.builtin.package:
        name: snapd
        state: present
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Enable and start snapd.socket (AL2)
      ansible.builtin.systemd:
        name: snapd.socket
        state: started
        enabled: true
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Ensure /snap symlink exists (AL2)
      ansible.builtin.file:
        src: /var/lib/snapd/snap
        path: /snap
        state: link
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Install core and certbot via snap (AL2)
      ansible.builtin.command: "{{ item }}"
      loop:
        - snap install core
        - snap install --classic certbot
      args:
        creates: /snap/bin/certbot
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Symlink certbot to /usr/bin (AL2)
      ansible.builtin.file:
        src: /snap/bin/certbot
        path: /usr/bin/certbot
        state: link
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Install EPEL release (AL2023)
      ansible.builtin.dnf:
        name: epel-release
        state: present
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2023', '==')

    - name: Install certbot and nginx plugin (AL2023)
      ansible.builtin.dnf:
        name:
          - certbot
          - python3-certbot-nginx
        state: present
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2023', '==')

    # Obtain certificate (requires DNS A record to this EC2 and ports 80/443 open).
    - name: Obtain Let's Encrypt certificate via nginx plugin
      ansible.builtin.command: >
        certbot --nginx -n --agree-tos
        -m {{ certbot_email }}
        -d {{ domain_name }} -d www.{{ domain_name }}
      args:
        creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
      notify: Reload nginx

    # Auto-renew.
    - name: Enable certbot auto-renew timer (snap) on AL2
      ansible.builtin.systemd:
        name: snap.certbot.renew.timer
        state: started
        enabled: true
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2', '==')

    - name: Install cron for certbot renew (AL2023)
      ansible.builtin.copy:
        dest: /etc/cron.d/certbot-renew
        content: |
          # Renew certs daily and reload nginx if changed
          SHELL=/bin/bash
          PATH=/sbin:/bin:/usr/sbin:/usr/bin
          30 2 * * * root certbot renew --quiet --deploy-hook "systemctl reload nginx"
        owner: root
        group: root
        mode: "0644"
      when:
        - ansible_facts["distribution"] == "Amazon"
        - ansible_facts["distribution_major_version"] is version('2023', '==')

    # Configure SSM + CloudWatchagent for logs and monitoring purposes.
    - name: Install SSM and CloudWatch agents
      ansible.builtin.package:
        name:
          - amazon-ssm-agent
          - amazon-cloudwatch-agent
        state: present
      when: ansible_facts["distribution"] == "Amazon"

    # Enable and start SSM agent.
    - name: Enable and start SSM agent
      ansible.builtin.systemd:
        name: amazon-ssm-agent
        state: started
        enabled: true
      when: ansible_facts["distribution"] == "Amazon"

    # Create the CloudWatch agent config.
    - name: Create CloudWatch Agent config
      ansible.builtin.copy:
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        owner: root
        group: root
        mode: "0644"
        content: |
          {
            "agent": {
              "region": "{{ aws_region }}"
            },
            "metrics": {
              "append_dimensions": {
                "InstanceId": "${aws:InstanceId}"
              },
              "metrics_collected": {
                "cpu": {
                  "measurement": ["cpu_usage_idle", "cpu_usage_user", "cpu_usage_system"],
                  "totalcpu": true,
                  "metrics_collection_interval": 60
                },
                "mem": {
                  "measurement": ["mem_used_percent"],
                  "metrics_collection_interval": 60
                },
                "disk": {
                  "measurement": ["used_percent"],
                  "resources": ["*"],
                  "metrics_collection_interval": 60
                }
              }
            },
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "/aws/ec2/{{ inventory_hostname }}/messages",
                      "log_stream_name": "{instance_id}"
                    },
                    {
                      "file_path": "/var/log/nginx/access.log",
                      "log_group_name": "/aws/ec2/{{ inventory_hostname }}/nginx-access",
                      "log_stream_name": "{instance_id}"
                    },
                    {
                      "file_path": "/var/log/nginx/error.log",
                      "log_group_name": "/aws/ec2/{{ inventory_hostname }}/nginx-error",
                      "log_stream_name": "{instance_id}"
                    }
                  ]
                }
              }
            }
          }
      notify: Restart CloudWatch agent
      when: ansible_facts["distribution"] == "Amazon"

    # Enable and start CloudWatch agent.
    - name: Enable and start CloudWatch Agent service
      ansible.builtin.systemd:
        name: amazon-cloudwatch-agent
        state: started
        enabled: true
      when: ansible_facts["distribution"] == "Amazon"

  handlers:
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded

    # Restart cloudwatch agent
    - name: Restart CloudWatch agent
      ansible.builtin.command: >
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl
        -a fetch-config -m ec2
        -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        -s
      changed_when: true
      when: ansible_facts["distribution"] == "Amazon"
